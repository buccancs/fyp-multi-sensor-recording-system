// Multi-project build configuration for Java/Android and Python components
plugins {
    // Apply Android and Kotlin plugins only to AndroidApp subproject
    id 'com.android.application' version '8.11.0' apply false
    id 'com.android.library' version '8.11.0' apply false
    id 'org.jetbrains.kotlin.android' version '2.0.20' apply false
    id 'com.google.devtools.ksp' version '2.0.20-1.0.24' apply false
    id 'com.google.dagger.hilt.android' version '2.52' apply false
}

// Global project information
allprojects {
    group = 'com.multisensor.recording'
    version = '0.1.0-beta'
}

// Multi-project build tasks
tasks.register('assembleAll') {
    group = 'build'
    description = 'Builds all components (Android APK and Python package)'
    
    dependsOn ':AndroidApp:assembleDebug'
    dependsOn ':PythonApp:pythonBuild'
    
    doLast {
        println "âœ“ All components assembled successfully"
        println "  - Android APK: ${project(':AndroidApp').layout.buildDirectory.get()}/outputs/apk/debug/"
        println "  - Python package: ${project(':PythonApp').layout.buildDirectory.get()}/dist/"
    }
}

tasks.register('assembleRelease') {
    group = 'build'
    description = 'Builds release versions of all components'
    
    dependsOn ':AndroidApp:assembleRelease'
    dependsOn ':PythonApp:pythonPackage'
    
    doLast {
        println "âœ“ Release build completed"
    }
}

tasks.register('checkAll') {
    group = 'verification'
    description = 'Runs verification tasks for all components'
    
    dependsOn ':AndroidApp:lintDebug'
    dependsOn ':PythonApp:pythonCheck'
    
    doLast {
        println "âœ“ All verification tasks completed"
    }
}

tasks.register('cleanAll') {
    group = 'build'
    description = 'Cleans all build artifacts'
    
    dependsOn ':AndroidApp:clean'
    dependsOn ':PythonApp:clean'
    
    doLast {
        println "âœ“ All build artifacts cleaned"
    }
}

// Setup task for development environment
tasks.register('setupEnvironment', Exec) {
    group = 'setup'
    description = 'Sets up complete development environment (Python conda environment)'
    
    workingDir = projectDir
    
    def isWindows = System.getProperty('os.name').toLowerCase().contains('windows')
    def condaCmd = isWindows ? 'conda.exe' : 'conda'
    
    commandLine = [condaCmd, 'env', 'create', '-f', 'environment.yml', '--force']
    ignoreExitValue = true
    
    doFirst {
        println "Setting up development environment..."
    }
    
    doLast {
        if (executionResult.get().exitValue == 0) {
            println "âœ“ Development environment setup completed"
        } else {
            println "âš  Failed to setup environment (exit code: ${executionResult.get().exitValue})"
            println "  Make sure conda is installed and environment.yml exists"
        }
    }
}

// Integration testing tasks (run from root level)
tasks.register('runIntegrationTests') {
    group = 'testing'
    description = 'Runs cross-platform integration tests'
    
    dependsOn ':AndroidApp:assembleDebug'
    dependsOn ':PythonApp:pythonTest'
    
    doLast {
        println "âœ“ Integration tests completed"
    }
}

// Specialized testing tasks for specific test suites
def createRootTestTask = { taskName, description, scriptName ->
    tasks.register(taskName, Exec) {
        group = 'testing'
        description = description
        workingDir = projectDir

        def isWindows = System.getProperty('os.name').toLowerCase().contains('windows')
        def pythonExe = isWindows ? 'python.exe' : 'python'

        commandLine = [pythonExe, scriptName]
        ignoreExitValue = true

        doFirst {
            println "Running ${description}..."
        }

        doLast {
            def status = executionResult.get().exitValue == 0 ? "âœ“ passed" : "âš  failed (exit code: ${executionResult.get().exitValue})"
            println "${description} ${status}"
        }
    }
}

// Create test tasks for the specific test suites found in the project
if (file('test_recording_full_suite.py').exists()) {
    createRootTestTask('runRecordingFullTest', 'Recording Functionality Full Test Suite', 'test_recording_full_suite.py')
}
if (file('test_device_management_full_suite.py').exists()) {
    createRootTestTask('runDeviceManagementFullTest', 'Device Management Full Test Suite', 'test_device_management_full_suite.py')
}
if (file('test_calibration_full_suite.py').exists()) {
    createRootTestTask('runCalibrationFullTest', 'Calibration Full Test Suite', 'test_calibration_full_suite.py')
}
if (file('test_file_management_full_suite.py').exists()) {
    createRootTestTask('runFileManagementFullTest', 'File Management Full Test Suite', 'test_file_management_full_suite.py')
}
if (file('test_network_connectivity_full_suite.py').exists()) {
    createRootTestTask('runNetworkConnectivityFullTest', 'Network Connectivity Full Test Suite', 'test_network_connectivity_full_suite.py')
}
if (file('test_all_full_suites.py').exists()) {
    createRootTestTask('runAllFullTestSuites', 'All Full Test Suites using orchestrator', 'test_all_full_suites.py')
}
if (file('test_ide_integration_suite.py').exists()) {
    createRootTestTask('runIDEIntegrationTest', 'IDE Integration Test Suite', 'test_ide_integration_suite.py')
}

// UI Test tasks
tasks.register('runPythonUITest', Exec) {
    group = 'testing'
    description = 'Runs Python UI Integration Test standalone'
    workingDir = file('PythonApp')

    def isWindows = System.getProperty('os.name').toLowerCase().contains('windows')
    def pythonExe = isWindows ? 'python.exe' : 'python'

    commandLine = [pythonExe, 'test_python_ui_integration.py']
    ignoreExitValue = true

    doFirst { println "Running Python UI Integration Test..." }
    doLast {
        def status = executionResult.get().exitValue == 0 ? "âœ“ passed" : "âš  failed (exit code: ${executionResult.get().exitValue})"
        println "Python UI Test ${status}"
    }
}

tasks.register('runAndroidUITest', Exec) {
    group = 'testing'
    description = 'Runs Android IDE Integration UI Test standalone'
    workingDir = projectDir

    commandLine = ['./gradlew', ':AndroidApp:connectedAndroidTest', '-Pandroid.testInstrumentationRunnerArguments.class=com.multisensor.recording.IDEIntegrationUITest']
    ignoreExitValue = true

    doFirst { println "Running Android IDE Integration UI Test..." }
    doLast {
        def status = executionResult.get().exitValue == 0 ? "âœ“ passed" : "âš  failed (exit code: ${executionResult.get().exitValue})"
        println "Android UI Test ${status}"
    }
}

tasks.register('buildHelp') {
    group = 'help'
    description = 'Displays help information for this multi-project build'
    
    doLast {
        println """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     Multi-Sensor Recording System - Gradle Build Help                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This is a multi-project Gradle build that combines Java/Android and Python components.

ğŸ—ï¸  BUILD TASKS:
   ./gradlew assembleAll       - Build all components (Android APK + Python package)
   ./gradlew assembleRelease   - Build release versions of all components
   ./gradlew cleanAll          - Clean all build artifacts

ğŸ” VERIFICATION TASKS:
   ./gradlew checkAll          - Run all verification tasks (lint + tests)
   ./gradlew :AndroidApp:lint  - Run Android linting
   ./gradlew :PythonApp:pythonLint - Run Python linting
   ./gradlew :PythonApp:pythonTest - Run Python tests

ğŸ§ª TESTING TASKS:
   ./gradlew runIntegrationTests - Run cross-platform integration tests
   ./gradlew runPythonUITest     - Run Python UI tests
   ./gradlew runAndroidUITest    - Run Android UI tests

âš™ï¸  SETUP TASKS:
   ./gradlew setupEnvironment   - Setup development environment (conda)
   ./gradlew :PythonApp:pythonInstallDeps - Install Python dependencies

ğŸ—‚ï¸  PROJECT STRUCTURE:
   AndroidApp/    - Android/Kotlin application (build.gradle.kts)
   PythonApp/     - Python application (build.gradle)
   
For more detailed task information, run:
   ./gradlew tasks --group=<build|verification|testing|setup>
   
        """
    }
}
